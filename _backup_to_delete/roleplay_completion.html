{% extends "base.html" %}

{% block head %}
<link href="{{url_for('static', filename='css/bootstrap.css')}}" rel="stylesheet">
<link href="{{url_for('static', filename='css/site.css')}}" rel="stylesheet">
<link href="{{url_for('static', filename='css/style.css')}}" rel="stylesheet">
<script src="{{url_for('static', filename='js/fontawesome.js')}}" crossorigin="anonymous"></script>

{% if cluster_type == 'assessment' %}
<!-- Assessment mode: Redirect to homepage with flash message -->
<script>
console.log('Cluster type: assessment - redirecting to homepage');
window.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, redirecting to cluster dashboard');
    // Redirect to cluster dashboard
    window.location.href = '/user/{{ user_id }}/cluster/{{ cluster_id }}?completed=1';
});
</script>
{% else %}
<!-- Training mode: Show full completion page -->
<style>
    body {
        background: url("{{url_for('static', filename='images/login_page_bg.jpg')}}");
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .completion-container {
        background: white;
        border-radius: 15px;
        padding: 50px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        text-align: center;
        max-width: 600px;
        margin: 20px;
        border: 2px solid #e0e0e0;
    }
    
    .completion-icon {
        font-size: 80px;
        margin-bottom: 20px;
        animation: scaleIn 0.5s ease-in-out;
    }
    
    @keyframes scaleIn {
        from {
            transform: scale(0);
        }
        to {
            transform: scale(1);
        }
    }
    
    .completion-title {
        font-size: 36px;
        font-weight: bold;
        color: #333;
        margin-bottom: 15px;
    }
    
    .completion-message {
        font-size: 18px;
        color: #666;
        margin-bottom: 40px;
    }
    
    .options-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-top: 30px;
    }
    
    .option-btn {
        padding: 16px 30px;
        font-size: 17px;
        font-weight: 600;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
    }
    
    .option-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(0,0,0,0.15);
    }
    
    .btn-retry {
        background: #28a745;
        color: white;
        border: 2px solid #28a745;
    }
    
    .btn-retry:hover:not(:disabled) {
        background: #218838;
        border-color: #218838;
    }
    
    .btn-retry:disabled {
        background: #f5f5f5;
        color: #999;
        border-color: #ddd;
        cursor: not-allowed;
        opacity: 0.6;
    }
    
    .btn-retry:disabled:hover {
        transform: none;
        box-shadow: none;
    }
    
    .btn-optimal {
        background: white;
        color: #28a745;
        border: 2px solid #28a745;
    }
    
    .btn-optimal:hover {
        background: #28a745;
        color: white;
    }
    
    .btn-home {
        background: white;
        color: #28a745;
        border: 2px solid #28a745;
        display: flex;
        flex-direction: column;
        padding: 20px;
    }
    
    .btn-home:hover {
        background: #28a745;
        color: white;
    }
    
    .btn-home i {
        font-size: 32px;
        margin-bottom: 6px;
    }
    
    .attempts-info {
        background: #d4edda;
        border-left: 4px solid #28a745;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
        text-align: left;
        color: #155724;
    }
    
    .attempts-info strong {
        color: #28a745;
    }
    
    /* Warning Modal Styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.6);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }
    
    .modal-content {
        background: white;
        padding: 40px;
        border-radius: 12px;
        max-width: 500px;
        text-align: center;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        border: 2px solid #e0e0e0;
    }
    
    .modal-icon {
        font-size: 60px;
        color: #ffc107;
        margin-bottom: 20px;
    }
    
    .modal-title {
        font-size: 24px;
        font-weight: bold;
        color: #333;
        margin-bottom: 15px;
    }
    
    .modal-message {
        font-size: 16px;
        color: #666;
        margin-bottom: 30px;
        line-height: 1.6;
    }
    
    .modal-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
    }
    
    .modal-btn {
        padding: 12px 30px;
        font-size: 16px;
        font-weight: 600;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-cancel {
        background: #f5f5f5;
        color: #333;
        border: 2px solid #ddd;
    }
    
    .btn-confirm {
        background: #28a745;
        color: white;
        border: 2px solid #28a745;
    }
    
    .btn-cancel:hover {
        background: #e0e0e0;
    }
    
    .btn-confirm:hover {
        background: #218838;
        border-color: #218838;
    }
</style>
{% endif %}
{% endblock %}

{% block content %}
{% if cluster_type != 'assessment' %}
<!-- Only show completion page for training mode -->
<div class="completion-container">
    <div class="completion-icon">üéâ</div>
    <h1 class="completion-title">Great Work!</h1>
    <p class="completion-message">You completed this training roleplay.</p>
    
    {% if attempts_remaining > 0 %}
    <div class="attempts-info">
        <strong>Attempts Remaining:</strong> {{ attempts_remaining }} out of {{ max_attempts }}
    </div>
    {% endif %}
    
    <div class="options-container">
        <!-- Retry Button -->
        {% if max_attempts > 1 %}
            {% if attempts_remaining > 0 %}
                <a href="/launch/{{ user_id }}/{{ roleplay_id }}?cluster_id={{ cluster_id }}" class="option-btn btn-retry">
                    <i class="fas fa-redo"></i>
                    <span>Retry</span>
                </a>
            {% else %}
                <button class="option-btn btn-retry" disabled>
                    <i class="fas fa-redo"></i>
                    <span>Retry (No attempts remaining)</span>
                </button>
            {% endif %}
        {% endif %}
        
        <!-- See Optimal Roleplay Button -->
        {% if show_ideal_video and ideal_video_path %}
            {% if max_attempts > 1 and attempts_remaining > 0 %}
                <button onclick="showWarningModal()" class="option-btn btn-optimal">
                    <i class="fas fa-video"></i>
                    <span>See Optimal Roleplay</span>
                </button>
            {% else %}
                <a href="{{ url_for('view_optimal_roleplay', user_id=user_id, cluster_id=cluster_id, roleplay_id=roleplay_id) }}" class="option-btn btn-optimal">
                    <i class="fas fa-video"></i>
                    <span>See Optimal Roleplay</span>
                </a>
            {% endif %}
        {% endif %}
        
        <!-- Go to Home Button -->
        <a href="{{ url_for('user_cluster_view', user_id=user_id, cluster_id=cluster_id) }}" class="option-btn btn-home">
            <i class="fas fa-home"></i>
            <span>Go to HOME</span>
        </a>
    </div>
</div>

<!-- Warning Modal -->
<div id="warningModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-icon">‚ö†Ô∏è</div>
        <h2 class="modal-title">Warning</h2>
        <p class="modal-message">
            Once you see the optimal roleplay, you cannot reattempt this roleplay. 
            Are you sure you want to continue?
        </p>
        <div class="modal-buttons">
            <button onclick="closeWarningModal()" class="modal-btn btn-cancel">Cancel</button>
            <a href="{{ url_for('view_optimal_roleplay', user_id=user_id, cluster_id=cluster_id, roleplay_id=roleplay_id) }}" class="modal-btn btn-confirm">Yes, Continue</a>
        </div>
    </div>
</div>

<script>
function showWarningModal() {
    document.getElementById('warningModal').style.display = 'flex';
}

function closeWarningModal() {
    document.getElementById('warningModal').style.display = 'none';
}

// Close modal when clicking outside
document.getElementById('warningModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeWarningModal();
    }
});
</script>
{% else %}
<!-- Testing mode: Just show loading message while redirect happens -->
<div style="text-align: center; padding: 50px;">
    <h2>Roleplay Completed!</h2>
    <p>Redirecting to dashboard...</p>
</div>
{% endif %}
{% endblock %}
