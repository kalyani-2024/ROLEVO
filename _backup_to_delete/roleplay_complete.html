{% extends "base.html" %}

{% block head %}
<link href="{{url_for('static', filename='css/bootstrap.css')}}" rel="stylesheet">
<script src="{{url_for('static', filename='js/fontawesome.js')}}" crossorigin="anonymous"></script>
<style>
    body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .completion-container {
        max-width: 600px;
        width: 90%;
        background: white;
        border-radius: 30px;
        padding: 50px 40px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        text-align: center;
        animation: slideUp 0.5s ease;
    }
    
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .celebration-icon {
        font-size: 5rem;
        margin-bottom: 20px;
        animation: bounce 1s ease infinite;
    }
    
    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-20px); }
    }
    
    .completion-title {
        font-size: 2.5rem;
        font-weight: bold;
        color: #16a34a;
        margin-bottom: 15px;
    }
    
    .completion-subtitle {
        font-size: 1.2rem;
        color: #6b7280;
        margin-bottom: 40px;
    }
    
    .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-top: 30px;
    }
    
    .action-btn {
        width: 100%;
        padding: 18px 30px;
        border: none;
        border-radius: 15px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        text-decoration: none;
        color: white;
    }
    
    .action-btn:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    
    .action-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: #d1d5db !important;
    }
    
    .btn-retry {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }
    
    .btn-retry:hover:not(:disabled) {
        box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
    }
    
    .btn-optimal {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    }
    
    .btn-optimal:hover:not(:disabled) {
        box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
    }
    
    .btn-home {
        background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
    }
    
    .btn-home:hover {
        box-shadow: 0 8px 25px rgba(22, 163, 74, 0.4);
    }
    
    .home-icon-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
    }
    
    .home-icon {
        font-size: 1.5rem;
    }
    
    .attempts-warning {
        background: #fef3c7;
        border: 2px solid #f59e0b;
        border-radius: 12px;
        padding: 15px;
        margin-top: 20px;
        color: #92400e;
        font-size: 1rem;
        line-height: 1.5;
    }
    
    /* Warning Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.7);
        animation: fadeIn 0.3s ease;
    }
    
    .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .modal-content {
        background: white;
        border-radius: 25px;
        max-width: 550px;
        width: 90%;
        padding: 40px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        animation: slideUp 0.3s ease;
        text-align: center;
    }
    
    .modal-icon {
        font-size: 4rem;
        margin-bottom: 20px;
    }
    
    .modal-title {
        font-size: 1.8rem;
        font-weight: bold;
        color: #ef4444;
        margin-bottom: 20px;
    }
    
    .modal-text {
        font-size: 1.1rem;
        color: #374151;
        line-height: 1.6;
        margin-bottom: 30px;
    }
    
    .modal-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
    }
    
    .modal-btn {
        padding: 14px 30px;
        border: none;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .modal-btn-cancel {
        background: #e5e7eb;
        color: #374151;
    }
    
    .modal-btn-cancel:hover {
        background: #d1d5db;
    }
    
    .modal-btn-confirm {
        background: #ef4444;
        color: white;
    }
    
    .modal-btn-confirm:hover {
        background: #dc2626;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @media (max-width: 768px) {
        .completion-container {
            padding: 40px 30px;
        }
        
        .completion-title {
            font-size: 2rem;
        }
        
        .action-btn {
            font-size: 1rem;
            padding: 16px 25px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="completion-container">
    <div class="celebration-icon">üéâ</div>
    <h1 class="completion-title">Great Work!</h1>
    <p class="completion-subtitle">You completed this training roleplay</p>
    
    <div class="action-buttons">
        <!-- Retry Button -->
        <button class="action-btn btn-retry" 
                {% if not can_retry %}disabled{% endif %}
                onclick="retryRoleplay()">
            <i class="fas fa-redo"></i>
            <span>Retry {% if can_retry %}({{ attempts_remaining }} attempts left){% else %}(No attempts left){% endif %}</span>
        </button>
        
        <!-- See Optimal Roleplay Button -->
        <button class="action-btn btn-optimal" 
                {% if not show_ideal_video %}disabled{% endif %}
                onclick="showOptimalWarning()">
            <i class="fas fa-eye"></i>
            <span>See Optimal Roleplay</span>
        </button>
        
        <!-- Go to Home Button -->
        <a href="/user/{{ user_id }}/cluster/{{ cluster_id }}" class="action-btn btn-home">
            <div class="home-icon-wrapper">
                <i class="fas fa-home home-icon"></i>
                <span>HOME</span>
            </div>
        </a>
    </div>
    
    {% if can_retry and attempts_remaining > 0 %}
    <div class="attempts-warning">
        <strong>‚ö†Ô∏è Note:</strong> You have {{ attempts_remaining }} attempt(s) remaining for this roleplay. 
        Choose wisely! Viewing the optimal roleplay will prevent you from retrying.
    </div>
    {% endif %}
</div>

<!-- Warning Modal for Optimal Roleplay -->
<div id="optimalWarningModal" class="modal">
    <div class="modal-content">
        <div class="modal-icon">‚ö†Ô∏è</div>
        <h2 class="modal-title">Warning</h2>
        <p class="modal-text">
            Once you see the optimal roleplay you cannot reattempt this roleplay. 
            All remaining attempts will be forfeited.
        </p>
        <p class="modal-text" style="font-weight: bold;">
            Are you sure you want to continue?
        </p>
        <div class="modal-actions">
            <button class="modal-btn modal-btn-cancel" onclick="closeOptimalWarning()">
                No, Go Back
            </button>
            <button class="modal-btn modal-btn-confirm" onclick="viewOptimalRoleplay()">
                Yes, Show Video
            </button>
        </div>
    </div>
</div>

<script>
function retryRoleplay() {
    {% if can_retry %}
    window.location.href = '/launch/{{ user_id }}/{{ roleplay_id }}';
    {% endif %}
}

function showOptimalWarning() {
    {% if show_ideal_video %}
        {% if can_retry and attempts_remaining > 0 %}
        document.getElementById('optimalWarningModal').classList.add('show');
        {% else %}
        viewOptimalRoleplay();
        {% endif %}
    {% endif %}
}

function closeOptimalWarning() {
    document.getElementById('optimalWarningModal').classList.remove('show');
}

function viewOptimalRoleplay() {
    {% if ideal_video_path %}
    // Open video in new window
    window.open('{{ url_for("static", filename=ideal_video_path) }}', '_blank', 'width=800,height=600');
    
    // Mark this roleplay as completed (no more attempts)
    fetch('/user/{{ user_id }}/cluster/{{ cluster_id }}/roleplay/{{ roleplay_id }}/submit', {
        method: 'POST'
    }).then(() => {
        closeOptimalWarning();
        setTimeout(() => {
            window.location.href = '/user/{{ user_id }}/cluster/{{ cluster_id }}';
        }, 1000);
    });
    {% else %}
    alert('Optimal roleplay video is not available for this scenario.');
    {% endif %}
}

// Close modal when clicking outside
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.classList.remove('show');
    }
}
</script>
{% endblock %}